<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MIMI Roulette</title>
    
    <link rel="icon" type="image/png" href="src/icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f5f7fa" id="metaThemeColor">
    <link rel="apple-touch-icon" href="src/icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;600&family=Zen+Kaku+Gothic+New:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            /* Light Theme */
            --bg-start: #f5f7fa;
            --bg-end: #c3cfe2;
            --bg-gradient: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.4);
            --text-main: #2c3e50;
            --text-sub: #5f6c7b;
            --accent: #74ebd5;
            --accent-grad: linear-gradient(135deg, #9FACE6 0%, #74ebd5 100%);
            --shadow: 0 15px 35px rgba(0,0,0,0.1);
            --modal-bg: rgba(255, 255, 255, 0.95);
            --item-h: 70px;
            --input-border: rgba(0, 0, 0, 0.15); 
            --input-bg: rgba(255, 255, 255, 0.8);
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-start: #0f172a;
            --bg-end: #312e81;
            --bg-gradient: linear-gradient(135deg, var(--bg-start) 0%, #1e1b4b 50%, var(--bg-end) 100%);
            --glass-bg: rgba(20, 25, 40, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #e2e8f0;
            --text-sub: #94a3b8;
            --accent: #818cf8;
            --accent-grad: linear-gradient(135deg, #6366f1 0%, #a5b4fc 100%);
            --shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            --modal-bg: rgba(15, 23, 42, 0.95);
            --input-border: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        html {
            background-color: var(--bg-start);
            transition: background-color 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            height: 100%;
        }

        body {
            margin: 0; font-family: 'Zen Kaku Gothic New', sans-serif;
            background: var(--bg-gradient); height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-main); 
            transition: background 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            overflow: hidden;
            padding-top: env(safe-area-inset-top); 
            padding-bottom: env(safe-area-inset-bottom);
        }

        .header {
            position: absolute; top: 0; left: 0; width: 100%; 
            padding: calc(20px + env(safe-area-inset-top)) 30px 20px;
            display: flex; justify-content: space-between; align-items: center; z-index: 20;
        }
        .logo { 
            font-family: 'Inter', sans-serif; font-weight: 300; 
            letter-spacing: 0.1em; font-size: 1.1rem; opacity: 0.9; text-transform: uppercase;
        }
        .header-controls { display: flex; gap: 12px; }

        .icon-btn {
            background: transparent; border: 1px solid transparent; border-radius: 50%;
            width: 44px; height: 44px; 
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; color: var(--text-main); transition: all 0.3s ease;
            position: relative;
        }
        .icon-btn:hover { background: var(--glass-border); transform: scale(1.1); }
        .icon-btn .material-icons-round { 
            font-size: 24px; transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .icon-btn:hover .material-icons-round { transform: rotate(15deg); }

        .info-btn {
            position: fixed; bottom: max(20px, env(safe-area-inset-bottom)); right: 20px;
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            color: var(--text-sub); display: flex; justify-content: center; align-items: center;
            cursor: pointer; opacity: 0.6; transition: 0.3s; z-index: 50;
            backdrop-filter: blur(5px);
        }
        .info-btn:hover { opacity: 1; transform: scale(1.1); background: var(--glass-border); }

        .container {
            width: 90%; max-width: 420px; height: 55vh; max-height: 500px;
            background: var(--glass-bg); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-radius: 40px; border: 1px solid var(--glass-border);
            box-shadow: var(--shadow); position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden;
            transition: all 0.5s ease;
        }

        .reel-window {
            width: 100%; height: 280px; position: relative; overflow: hidden;
            mask-image: linear-gradient(to bottom, transparent 0%, black 25%, black 75%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 25%, black 75%, transparent 100%);
        }
        .reel-list { list-style: none; padding: 0; margin: 0; width: 100%; position: absolute; top: 0; left: 0; }
        
        .reel-item {
            height: var(--item-h); display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; color: var(--text-sub); font-weight: 400;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 25px;
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), color 0.4s ease, text-shadow 0.4s ease;
        }
        .reel-item.winner-active {
            color: var(--text-main); font-weight: 700; transform: scale(1.2);
            text-shadow: 0 0 25px rgba(116, 235, 213, 0.5);
        }
        [data-theme="dark"] .reel-item.winner-active {
            text-shadow: 0 0 25px rgba(165, 180, 252, 0.6); color: #fff;
        }

        .selection-frame {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70%; height: var(--item-h);
            border-top: 1px solid var(--accent); border-bottom: 1px solid var(--accent);
            background: linear-gradient(90deg, transparent, rgba(116, 235, 213, 0.05), transparent);
            pointer-events: none; z-index: 5; opacity: 0.6;
        }

        .spin-btn {
            margin-top: 40px; width: 180px; padding: 18px 0; border: none; border-radius: 100px;
            background: var(--accent-grad); color: #fff;
            font-family: 'Inter', sans-serif; font-size: 1rem; 
            font-weight: 300; letter-spacing: 0.25em;
            cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.3s; z-index: 10;
        }
        .spin-btn:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .spin-btn:active { transform: scale(0.98); }
        .spin-btn:disabled { opacity: 0.6; cursor: default; transform: none; box-shadow: none; filter: grayscale(0.4); }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            z-index: 100; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.4s ease;
            padding-top: env(safe-area-inset-top);
        }
        .modal.active { opacity: 1; pointer-events: all; }
        
        .modal-card {
            background: var(--modal-bg); width: 88%; max-width: 380px; padding: 45px 35px;
            border-radius: 36px; border: 1px solid var(--glass-border); text-align: center;
            box-shadow: 0 30px 60px -15px rgba(0,0,0,0.3);
            transform: scale(0.9) translateY(20px); transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            max-height: 85vh; overflow-y: auto; display:flex; flex-direction:column; align-items:center;
            scrollbar-width: thin; scrollbar-color: var(--accent) transparent;
        }
        .modal.active .modal-card { transform: scale(1) translateY(0); }

        .res-singer-badge {
            background: rgba(127,127,127,0.1); color: var(--text-sub);
            padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 500;
            margin-bottom: 15px; border: 1px solid var(--glass-border); font-family: 'Inter';
        }
        .res-title-main {
            font-size: 1.8rem; font-weight: 700; line-height: 1.3;
            background: linear-gradient(135deg, var(--text-main) 30%, var(--text-sub) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 8px; 
            word-wrap: break-word; overflow-wrap: break-word; white-space: normal; max-width: 100%;
            letter-spacing: -0.02em;
        }
        .res-title-main.long { font-size: 1.5rem; }
        .res-title-main.very-long { font-size: 1.25rem; }
        .res-artist-sub { font-size: 1rem; color: var(--text-sub); margin-bottom: 40px; letter-spacing: 0.05em; font-weight: 300; }

        .action-btn {
            display: flex; justify-content: center; align-items: center; width: 100%; padding: 15px 0;
            border-radius: 18px; margin-bottom: 12px; text-decoration: none; font-weight: 600; color: #fff;
            font-size: 0.95rem; border: none; cursor: pointer; transition: transform 0.2s, opacity 0.2s;
            font-family: 'Inter';
        }
        .action-btn:hover { transform: translateY(-2px); opacity: 0.95; }
        .btn-yt { background: #1a1a1a; } [data-theme="dark"] .btn-yt { background: #e02d2d; }
        .btn-tw { background: #000; } [data-theme="dark"] .btn-tw { background: #fff; color:#000; }
        .btn-post { background: var(--accent-grad); margin-top:10px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }

        .share-area {
            width: 100%; height: 120px; border-radius: 18px; padding: 18px;
            border: 1px solid var(--glass-border); background: var(--input-bg);
            font-family: 'Zen Kaku Gothic New', sans-serif; font-size: 0.95rem; resize: none; margin-bottom: 8px;
            color: var(--text-main); line-height: 1.5;
        }
        .share-area:focus { outline: 2px solid var(--accent); border-color: transparent; }
        .char-count { font-size: 0.8rem; color: var(--text-sub); align-self: flex-end; margin-bottom: 25px; font-family: 'Inter'; }
        .char-count.error { color: #ef4444; }

        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--glass-border); width:100%; }
        .setting-label { font-size: 1rem; font-weight: 500; }
        .setting-desc { font-size: 0.8rem; color: var(--text-sub); margin-top: 4px; }
        
        .switch { position: relative; display: inline-block; width: 48px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1; border-radius: 34px; transition: .4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .slider:before {
            position: absolute; content: ""; height: 22px; width: 22px;
            left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }
        input:disabled + .slider { opacity: 0.5; cursor: not-allowed; }

        .mode-select { display: flex; gap: 10px; margin-top: 10px; width: 100%; }
        .mode-btn {
            flex: 1; padding: 10px; border-radius: 12px; border: 1px solid var(--glass-border);
            background: transparent; color: var(--text-sub); cursor: pointer; transition: 0.2s;
            font-size: 0.9rem; font-weight: 600;
        }
        .mode-btn.active {
            background: var(--accent); color: #fff; border-color: transparent;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .close-link { margin-top: 20px; text-decoration: underline; cursor: pointer; color: var(--text-sub); font-size: 0.85rem; }
        .day-badge {
            position: absolute; top: calc(80px + env(safe-area-inset-top)); 
            background: var(--accent); color: #fff;
            padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-family: 'Inter'; z-index: 15;
        }

        .search-box {
            width: 100%; padding: 12px 15px; border-radius: 15px; 
            border: 1px solid var(--input-border); 
            background: var(--input-bg); 
            color: var(--text-main); margin-bottom: 15px;
            font-family: inherit; font-size: 0.95rem;
        }
        .song-list-scroll { width: 100%; flex: 1; overflow-y: auto; max-height: 400px; padding-right: 5px; }
        .song-toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--glass-border); }
        .song-info { display: flex; flex-direction: column; text-align: left; max-width: 80%; }
        .song-title-sm { font-weight: 600; font-size: 0.95rem; }
        .song-singer-sm { font-size: 0.8rem; color: var(--text-sub); }
        
        .list-controls { display: flex; gap: 10px; margin-bottom: 10px; width: 100%; }
        .btn-mini { 
            flex: 1; padding: 8px; border-radius: 10px; 
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: var(--text-main); font-size: 0.8rem; cursor: pointer;
        }
        .daily-input { 
            width: 60px; padding: 5px; border-radius: 8px; border: 1px solid var(--input-border); 
            text-align: center; background: var(--input-bg); color: var(--text-main); font-weight: 600; 
        }

        .stat-group { width: 100%; margin-bottom: 20px; text-align: left; }
        .stat-label { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 5px; font-weight: 500; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .stat-bar-container { width: 100%; margin-bottom: 10px; }
        .stat-bar-label { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 4px; color: var(--text-main); }
        .stat-bar-bg { width: 100%; height: 10px; background: rgba(127,127,127,0.1); border-radius: 5px; overflow: hidden; }
        .stat-bar-fill { height: 100%; background: var(--accent-grad); border-radius: 5px; transition: width 1s cubic-bezier(0.19, 1, 0.22, 1); }

        .info-link-row { display: flex; flex-direction: column; gap: 15px; width: 100%; margin-bottom: 20px; }
        .info-link {
            display: flex; align-items: center; gap: 15px; text-decoration: none; color: var(--text-main);
            padding: 15px; border-radius: 16px; border: 1px solid var(--glass-border); transition: 0.2s;
            justify-content: center; text-align: center;
        }
        .info-link:hover { background: rgba(127,127,127,0.05); transform: translateY(-2px); }
        .info-link i, .info-link .material-icons-round { font-size: 24px; color: var(--accent); }
        .info-text { font-size: 1rem; font-weight: 600; }
        .info-sub { font-size: 0.8rem; color: var(--text-sub); }
        .license-text { font-size: 0.75rem; color: var(--text-sub); text-align: center; line-height: 1.6; margin-top: 10px; }

    </style>
</head>
<body>

    <div class="header">
        <div class="logo">MIMI Roulette</div>
        <div class="header-controls">
            <button id="songsBtn" class="icon-btn" title="Songs"><span class="material-icons-round">queue_music</span></button>
            <button id="themeToggle" class="icon-btn" title="Theme"><span class="material-icons-round">dark_mode</span></button>
            <button id="settingsBtn" class="icon-btn" title="Settings"><span class="material-icons-round">settings</span></button>
        </div>
    </div>

    <button id="infoBtn" class="info-btn" title="Information"><span class="material-icons-round">info</span></button>

    <div id="dailyBadge" class="day-badge" style="display:none;">Day 1</div>

    <div class="container">
        <div class="reel-window">
            <div class="selection-frame"></div>
            <ul class="reel-list" id="reelList">
                <li class="reel-item">Loading...</li>
            </ul>
        </div>
        <button id="spinBtn" class="spin-btn">SPIN</button>
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-card">
            <div id="resSinger" class="res-singer-badge">Singer</div>
            <div id="resTitle" class="res-title-main">Title</div>
            <div id="resArtist" class="res-artist-sub">MIMI</div>
            <a id="btnYt" href="#" target="_blank" class="action-btn btn-yt">
                <span style="margin-right:8px">▶</span> <span data-i18n="youtube">Play on YouTube</span>
            </a>
            <button id="btnOpenShare" class="action-btn btn-tw"><span data-i18n="share">Share on X</span></button>
            <div onclick="closeModal('resultModal')" class="close-link" data-i18n="close">Close</div>
        </div>
    </div>

    <div id="shareModal" class="modal">
        <div class="modal-card">
            <h3 style="margin-top:0; color:var(--text-main);" data-i18n="shareTitle">Post to X</h3>
            <textarea id="shareInput" class="share-area" placeholder=""></textarea>
            <div id="charCount" class="char-count">140</div>
            <button id="btnPostX" class="action-btn btn-post" data-i18n="post">Post</button>
            <div onclick="closeModal('shareModal')" class="close-link" data-i18n="cancel">Cancel</div>
        </div>
    </div>

    <div id="songListModal" class="modal">
        <div class="modal-card" style="max-height: 80vh; width: 92%;">
            <h3 style="margin:0 auto 15px; color:var(--text-main);" data-i18n="manageSongs">Songs</h3>
            <input type="text" id="songSearch" class="search-box" placeholder="Search..." oninput="renderSongList()">
            <div class="list-controls">
                <button class="btn-mini" onclick="toggleAllSongs(true)" data-i18n="selectAll">All On</button>
                <button class="btn-mini" onclick="toggleAllSongs(false)" data-i18n="deselectAll">All Off</button>
            </div>
            <div id="songListContainer" class="song-list-scroll"></div>
            <div onclick="closeModal('songListModal')" class="close-link" data-i18n="close">Close</div>
        </div>
    </div>

    <div id="infoModal" class="modal">
        <div class="modal-card">
            <h3 style="margin:0 auto 25px; color:var(--text-main);" data-i18n="infoTitle">Information</h3>
            <div class="info-link-row">
                <a href="https://x.com/lineside0418" target="_blank" class="info-link">
                    <i class="fa-brands fa-x-twitter"></i>
                    <div>
                        <div class="info-text">@lineside0418</div>
                        <div class="info-sub" data-i18n="developer">Developer</div>
                    </div>
                </a>
                <a href="https://github.com/lineside0418/MIMI_Roulette" target="_blank" class="info-link">
                    <i class="fa-brands fa-github"></i>
                    <div>
                        <div class="info-text">MIMI Roulette</div>
                        <div class="info-sub" data-i18n="source">Source Code & Stars</div>
                    </div>
                </a>
                <a href="https://youtube.com/@mimi...official?si=JqEQWSUqPltUO2fT" target="_blank" class="info-link">
                    <i class="fa-brands fa-youtube"></i>
                    <div>
                        <div class="info-text">MIMI</div>
                        <div class="info-sub" data-i18n="officialCh">Official Channel</div>
                    </div>
                </a>
            </div>
            <div class="license-text">
                <span data-i18n="version">Version</span> 1.3.1<br>
                <span data-i18n="license">This project is licensed under the MIT License.</span><br>
                Music and Art rights belong to MIMI and respective artists.
            </div>
            <div onclick="closeModal('infoModal')" class="close-link" data-i18n="close">Close</div>
        </div>
    </div>

    <div id="statsModal" class="modal">
        <div class="modal-card" style="align-items: flex-start;">
            <h3 style="margin:0 auto 20px; color:var(--text-main);" data-i18n="statsTitle">Statistics</h3>
            <div class="stat-group">
                <div class="stat-label" data-i18n="totalSpins">Total Spins</div>
                <div class="stat-value" id="statTotal">0</div>
            </div>
            <div class="stat-group">
                <div class="stat-label" data-i18n="topSongs">Top 5 Songs</div>
                <div id="statTopList" style="width:100%;"></div>
            </div>
            <div onclick="closeModal('statsModal')" class="close-link" style="width:100%; text-align:center;" data-i18n="close">Close</div>
        </div>
    </div>

    <div id="resetModal" class="modal">
        <div class="modal-card">
            <span class="material-icons-round" style="font-size:48px; color:var(--accent); margin-bottom:15px;">check_circle</span>
            <div style="font-size:1.2rem; font-weight:700; margin-bottom:10px;" data-i18n="completeTitle">Completed!</div>
            <div style="font-size:0.9rem; color:var(--text-sub); margin-bottom:20px; line-height:1.6;" data-i18n="completeDesc">
                All songs played. Reset list?
            </div>
            <button id="btnResetConfirm" class="action-btn btn-post" data-i18n="reset">Reset List</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-card" style="text-align: left; align-items:flex-start;">
            <h3 style="margin:0 auto 20px; color:var(--text-main); font-weight:600;" data-i18n="settings">Settings</h3>
            
            <div class="setting-row">
                <span data-i18n="language">Language</span>
                <div style="display:flex; align-items:center; gap:8px; font-weight:600; font-size:0.9rem;">
                    <span id="langLabel" style="color:var(--accent);">JA</span>
                    <label class="switch"><input type="checkbox" id="langToggle"><span class="slider"></span></label>
                </div>
            </div>

            <div class="setting-row">
                <div>
                    <div>Haptics</div>
                    <div class="setting-desc" data-i18n="hapticsDesc">Vibration feedback</div>
                </div>
                <label class="switch"><input type="checkbox" id="checkHaptics"><span class="slider"></span></label>
            </div>

            <div class="setting-row" onclick="openStats()" style="cursor:pointer;">
                <span style="font-weight:600;" data-i18n="statsLink">Statistics</span>
                <span class="material-icons-round" style="color:var(--text-sub);">bar_chart</span>
            </div>

            <div class="setting-row" style="flex-direction:column; align-items:flex-start;">
                <span data-i18n="mode">Play Mode</span>
                <div class="mode-select">
                    <button id="modeNormal" class="mode-btn active" onclick="setMode('normal')">Roulette</button>
                    <button id="modeDaily" class="mode-btn" onclick="setMode('daily')">Daily</button>
                </div>
                <div id="dailyControl" style="display:none; width:100%; margin-top:10px; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.9rem; color:var(--text-sub);" data-i18n="dayCount">Day Count:</span>
                    <input type="number" id="dailyInput" class="daily-input" value="1" min="1">
                </div>
                <div id="modeDesc" class="setting-desc" style="margin-top:8px;"></div>
            </div>

            <div class="setting-row">
                <div><div data-i18n="noRepeat">No Repeat</div><div class="setting-desc" data-i18n="noRepeatDesc">一度出た曲は出ません</div></div>
                <label class="switch"><input type="checkbox" id="checkNoRepeat"><span class="slider"></span></label>
            </div>

            <div class="setting-row">
                <span data-i18n="data">Data</span>
                <div style="display:flex; gap:10px;">
                    <button class="btn-mini" onclick="exportData()" data-i18n="export">Export</button>
                    <button class="btn-mini" onclick="document.getElementById('importFile').click()" data-i18n="import">Import</button>
                    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(this)">
                </div>
            </div>
            
            <div style="margin:20px 0 10px; font-weight:600;" data-i18n="history">History</div>
            <ul id="historyList" class="history-list" style="width:100%; list-style:none; padding:0; max-height:120px; overflow-y:auto;"><li>Empty</li></ul>
            <div style="text-align:right; width:100%;"><button class="close-link" style="background:none; border:none;" onclick="clearHistory()" data-i18n="clear">Clear</button></div>
            
            <div style="margin-top:20px; width:100%; text-align:center;">
                <div onclick="closeModal('settingsModal')" class="close-link" data-i18n="close">Close</div>
            </div>
        </div>
    </div>

    <script>
        // --- Service Worker ---
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

        // --- Localization ---
        const I18N = {
            ja: {
                youtube: "YouTubeで再生する", share: "Xでシェア", close: "閉じる",
                shareTitle: "感想を投稿", post: "ポストする", cancel: "キャンセル",
                completeTitle: "コンプリート！", completeDesc: "全ての曲を聴きました！<br>リストと日数をリセットしますか？",
                reset: "リセットする", settings: "設定", language: "言語 (JA/EN)",
                mode: "モード選択", noRepeat: "重複なし", noRepeatDesc: "一度出た曲は出ません",
                history: "履歴", clear: "履歴削除", empty: "履歴なし", placeholder: "感想を入力...",
                modeNormalDesc: "ランダムに曲を再生します", modeDailyDesc: "日数を記録し、全曲制覇を目指します",
                manageSongs: "曲の管理", selectAll: "全選択", deselectAll: "全解除", data: "データ",
                hapticsDesc: "振動フィードバック", statsLink: "統計", statsTitle: "統計データ",
                totalSpins: "総再生回数", topSongs: "トップ5",
                infoTitle: "インフォメーション", developer: "開発者", source: "ソースコード",
                officialCh: "公式チャンネル", version: "バージョン", license: "このプロジェクトはMITライセンスの下で公開されています。",
                dayCount: "日数:", export: "保存", import: "読込"
            },
            en: {
                youtube: "Play on YouTube", share: "Share on X", close: "Close",
                shareTitle: "Share Thoughts", post: "Post", cancel: "Cancel",
                completeTitle: "Completed!", completeDesc: "All songs played!<br>Reset list and day counter?",
                reset: "Reset List", settings: "Settings", language: "Language",
                mode: "Play Mode", noRepeat: "No Repeat", noRepeatDesc: "Don't play same song twice",
                history: "History", clear: "Clear History", empty: "No history", placeholder: "Write your thoughts...",
                modeNormalDesc: "Play songs randomly", modeDailyDesc: "Track days and aim for completion",
                manageSongs: "Manage Songs", selectAll: "All On", deselectAll: "All Off", data: "Data",
                hapticsDesc: "Vibration feedback", statsLink: "Statistics", statsTitle: "Statistics",
                totalSpins: "Total Spins", topSongs: "Top 5 Songs",
                infoTitle: "Information", developer: "Developer", source: "Source Code",
                officialCh: "Official Channel", version: "Version", license: "This project is licensed under the MIT License.",
                dayCount: "Day:", export: "Export", import: "Import"
            }
        };

        let currentLang = localStorage.getItem('mimi_lang') || 'ja';
        const CONFIG = { itemHeight: 70, spinDuration: 5, loops: 10 };
        
        // --- State ---
        let allSongs = [];
        let availableSongs = [];
        let history = JSON.parse(localStorage.getItem('mimi_history')) || [];
        let disabledSongs = JSON.parse(localStorage.getItem('mimi_disabled') || '[]');
        
        let currentMode = localStorage.getItem('mimi_mode') || 'normal'; 
        let dailyCount = parseInt(localStorage.getItem('mimi_daily_count') || '1');
        let hapticsEnabled = (localStorage.getItem('mimi_haptics') !== 'false'); // Default ON

        let currentWinner = null;
        let isSpinning = false;
        
        const els = {
            reel: document.getElementById('reelList'),
            spinBtn: document.getElementById('spinBtn'),
            themeBtn: document.getElementById('themeToggle'),
            langToggle: document.getElementById('langToggle'),
            langLabel: document.getElementById('langLabel'),
            shareInput: document.getElementById('shareInput'),
            charCount: document.getElementById('charCount'),
            noRepeatCheck: document.getElementById('checkNoRepeat'),
            dailyBadge: document.getElementById('dailyBadge'),
            modeDesc: document.getElementById('modeDesc'),
            dailyControl: document.getElementById('dailyControl'),
            dailyInput: document.getElementById('dailyInput'),
            songListContainer: document.getElementById('songListContainer'),
            songSearch: document.getElementById('songSearch'),
            hapticsCheck: document.getElementById('checkHaptics')
        };

        // --- Init ---
        async function init() {
            try {
                const res = await fetch('src/songs.json');
                allSongs = await res.json();
                
                renderStaticReel(); 
                updateHistoryUI();
                
                if(localStorage.getItem('theme') === 'dark') applyTheme('dark');
                applyLang(currentLang);
                setMode(currentMode);
                
                // Init settings state
                els.hapticsCheck.checked = hapticsEnabled;

            } catch (e) {
                console.error(e);
                els.reel.innerHTML = '<li class="reel-item">Error Loading Data</li>';
            }
        }
        init();

        // --- Haptics ---
        function triggerHaptic(ms = 10) {
            if(hapticsEnabled && navigator.vibrate) navigator.vibrate(ms);
        }
        els.hapticsCheck.addEventListener('change', (e) => {
            hapticsEnabled = e.target.checked;
            localStorage.setItem('mimi_haptics', hapticsEnabled);
            if(hapticsEnabled) triggerHaptic(50);
        });

        // --- Song Management ---
        function getActiveSongs() {
            return allSongs.filter(s => !disabledSongs.includes(s.url));
        }
        function renderSongList() {
            const query = els.songSearch.value.toLowerCase();
            const list = els.songListContainer;
            list.innerHTML = '';
            
            allSongs.forEach((song, idx) => {
                if(song.title.toLowerCase().includes(query) || song.singer.toLowerCase().includes(query)) {
                    const isEnabled = !disabledSongs.includes(song.url);
                    const div = document.createElement('div');
                    div.className = 'song-toggle-row';
                    div.innerHTML = `
                        <div class="song-info">
                            <span class="song-title-sm">${song.title}</span>
                            <span class="song-singer-sm">${song.singer}</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleSong('${song.url}')">
                            <span class="slider"></span>
                        </label>
                    `;
                    list.appendChild(div);
                }
            });
        }
        window.toggleSong = (url) => {
            if(disabledSongs.includes(url)) disabledSongs = disabledSongs.filter(u => u !== url);
            else disabledSongs.push(url);
            localStorage.setItem('mimi_disabled', JSON.stringify(disabledSongs));
        };
        window.toggleAllSongs = (enable) => {
            if(enable) disabledSongs = [];
            else disabledSongs = allSongs.map(s => s.url);
            localStorage.setItem('mimi_disabled', JSON.stringify(disabledSongs));
            renderSongList();
        };
        document.getElementById('songsBtn').addEventListener('click', () => {
            renderSongList();
            document.getElementById('songListModal').classList.add('active');
        });

        // --- Roulette Logic ---
        els.spinBtn.addEventListener('click', () => {
            if(isSpinning) return;
            const activePool = getActiveSongs();
            if(activePool.length === 0) { alert("No active songs!"); return; }

            const isNoRepeat = currentMode === 'daily' || els.noRepeatCheck.checked;
            availableSongs = availableSongs.filter(s => !disabledSongs.includes(s.url));
            let targetList = isNoRepeat ? availableSongs.filter(s => !disabledSongs.includes(s.url)) : activePool;

            if(targetList.length === 0) {
                 if(activePool.length > 0) document.getElementById('resetModal').classList.add('active');
                 return;
            }

            const winnerIndex = Math.floor(Math.random() * targetList.length);
            const winner = targetList[winnerIndex];
            if(isNoRepeat) availableSongs = availableSongs.filter(s => s.url !== winner.url);

            startSpin(winner, activePool);
        });

        function startSpin(winner, pool) {
            isSpinning = true;
            els.spinBtn.disabled = true;
            const fragment = document.createDocumentFragment();
            
            for(let i=0; i < CONFIG.loops; i++) pool.forEach(s => fragment.appendChild(createItem(s.title)));
            const winnerItem = createItem(winner.title);
            winnerItem.id = 'winnerItem';
            fragment.appendChild(winnerItem);
            for(let i=0; i<3; i++) pool.forEach(s => fragment.appendChild(createItem(s.title)));

            els.reel.innerHTML = '';
            els.reel.appendChild(fragment);
            gsap.set(els.reel, { y: 0 });

            const targetIndex = (pool.length * CONFIG.loops); 
            const targetY = 105 - (targetIndex * CONFIG.itemHeight);
            
            let lastY = 0;
            let distAcc = 0;

            gsap.to(els.reel, {
                y: targetY,
                duration: CONFIG.spinDuration,
                ease: "power4.out",
                onUpdate: function() {
                    const currentY = gsap.getProperty(els.reel, "y");
                    const delta = Math.abs(currentY - lastY);
                    distAcc += delta;
                    if(distAcc >= CONFIG.itemHeight) {
                        triggerHaptic(15);
                        distAcc -= CONFIG.itemHeight;
                    }
                    lastY = currentY;
                },
                onComplete: function() {
                    const winItem = document.getElementById('winnerItem');
                    if(winItem) winItem.classList.add('winner-active');
                    triggerHaptic(50); 
                    setTimeout(() => {
                        if(currentMode === 'daily') {
                            dailyCount++;
                            els.dailyInput.value = dailyCount;
                            localStorage.setItem('mimi_daily_count', dailyCount);
                            els.dailyBadge.innerText = `Day ${dailyCount}`;
                        }
                        showResult(winner);
                    }, 600); 
                }
            });
        }
        function createItem(text) {
            const li = document.createElement('li');
            li.className = 'reel-item';
            li.innerText = text;
            return li;
        }

        // --- Mode & Daily ---
        window.setMode = (mode) => {
            currentMode = mode;
            localStorage.setItem('mimi_mode', mode);
            
            document.getElementById('modeNormal').classList.toggle('active', mode === 'normal');
            document.getElementById('modeDaily').classList.toggle('active', mode === 'daily');
            
            if (mode === 'daily') {
                els.dailyBadge.style.display = 'block';
                els.dailyBadge.innerText = `Day ${dailyCount}`;
                els.dailyInput.value = dailyCount;
                els.noRepeatCheck.checked = true;
                els.noRepeatCheck.disabled = true;
                els.dailyControl.style.display = 'flex';
                els.modeDesc.innerText = I18N[currentLang].modeDailyDesc;
            } else {
                els.dailyBadge.style.display = 'none';
                els.noRepeatCheck.disabled = false;
                els.noRepeatCheck.checked = (localStorage.getItem('mimi_norepeat') === 'true');
                els.dailyControl.style.display = 'none';
                els.modeDesc.innerText = I18N[currentLang].modeNormalDesc;
            }
        };
        els.dailyInput.addEventListener('change', (e) => {
            let val = parseInt(e.target.value);
            if(val < 1) val = 1;
            dailyCount = val;
            localStorage.setItem('mimi_daily_count', val);
            els.dailyBadge.innerText = `Day ${val}`;
        });
        // Save NoRepeat state for Normal Mode
        els.noRepeatCheck.addEventListener('change', (e) => {
            if(currentMode === 'normal') localStorage.setItem('mimi_norepeat', e.target.checked);
        });

        // --- Result & Share ---
        function showResult(song) {
            currentWinner = song;
            const titleEl = document.getElementById('resTitle');
            titleEl.innerText = song.title;
            titleEl.className = 'res-title-main';
            if (song.title.length > 20) titleEl.classList.add('very-long');
            else if (song.title.length > 12) titleEl.classList.add('long');
            document.getElementById('resSinger').innerText = song.singer;
            document.getElementById('resArtist').innerText = song.artist;
            document.getElementById('btnYt').href = song.url;
            addToHistory(song);
            document.getElementById('resultModal').classList.add('active');
            confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 }, colors: ['#74ebd5', '#9FACE6', '#ffffff'] });
            isSpinning = false;
            els.spinBtn.disabled = false;
        }
        
        document.getElementById('btnOpenShare').addEventListener('click', () => {
            document.getElementById('resultModal').classList.remove('active');
            els.shareInput.value = '';
            els.shareInput.placeholder = I18N[currentLang].placeholder;
            updateCharCount();
            document.getElementById('shareModal').classList.add('active');
            els.shareInput.focus();
        });
        els.shareInput.addEventListener('input', updateCharCount);
        
        function updateCharCount() {
            if(!currentWinner) return;
            let header = currentMode === 'daily' ? `${dailyCount - 1}日目の曲は` : "今回の曲は";
            // Check English or Japanese for template
            if(currentLang === 'en') header = currentMode === 'daily' ? `Day ${dailyCount - 1} Song:` : "Today's Song:";
            
            const fixed = `${header}\n「${currentWinner.title}」 / 「${currentWinner.artist} (${currentWinner.singer})」\n\n\n\n↓「${currentWinner.title}」\n #MIMI_Roulette`;
            const len = fixed.length + 23 + els.shareInput.value.length;
            const remaining = 140 - len;
            els.charCount.innerText = remaining;
            els.charCount.classList.toggle('error', remaining < 0);
        }
        document.getElementById('btnPostX').addEventListener('click', () => {
             if(!currentWinner) return;
             let header = currentMode === 'daily' ? `${dailyCount - 1}日目の曲は` : "今回の曲は";
             if(currentLang === 'en') header = currentMode === 'daily' ? `Day ${dailyCount - 1} Song:` : "Today's Song:";
             
             const text = `${header}\n「${currentWinner.title}」 / 「${currentWinner.artist} (${currentWinner.singer})」\n\n${els.shareInput.value}\n\n↓「${currentWinner.title}」\n${currentWinner.url} #MIMI_Roulette`;
             window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank');
             document.getElementById('shareModal').classList.remove('active');
        });

        // --- Info & Stats ---
        document.getElementById('infoBtn').addEventListener('click', () => document.getElementById('infoModal').classList.add('active'));
        window.openStats = () => {
            document.getElementById('settingsModal').classList.remove('active'); // Close settings
            document.getElementById('statTotal').innerText = history.length;
            const counts = {};
            history.forEach(h => { counts[h.title] = (counts[h.title] || 0) + 1; });
            const sorted = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, 5);
            const maxVal = sorted.length > 0 ? counts[sorted[0]] : 1;
            const container = document.getElementById('statTopList');
            container.innerHTML = '';
            if(sorted.length === 0) container.innerHTML = '<div style="color:var(--text-sub); text-align:center;">No Data</div>';
            else {
                sorted.forEach(title => {
                    const val = counts[title];
                    const percent = (val / maxVal) * 100;
                    const div = document.createElement('div');
                    div.className = 'stat-bar-container';
                    div.innerHTML = `<div class="stat-bar-label"><span>${title}</span><span>${val}</span></div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:0%"></div></div>`;
                    container.appendChild(div);
                    setTimeout(() => { div.querySelector('.stat-bar-fill').style.width = `${percent}%`; }, 50);
                });
            }
            document.getElementById('statsModal').classList.add('active');
        };

        // --- Common Utils ---
        function addToHistory(song) {
            const date = new Date().toLocaleDateString();
            history.unshift({ title: song.title, date: date });
            if(history.length > 200) history.pop();
            localStorage.setItem('mimi_history', JSON.stringify(history));
            updateHistoryUI();
        }
        function updateHistoryUI() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            if(history.length === 0) { list.innerHTML = `<li style="padding:10px; color:var(--text-sub);">${I18N[currentLang].empty}</li>`; return; }
            history.slice(0, 50).forEach(h => {
                const li = document.createElement('li');
                li.style.cssText = "border-bottom:1px dashed var(--glass-border); padding:8px 0; display:flex; justify-content:space-between; font-size:0.9rem; color:var(--text-sub);";
                li.innerHTML = `<span>${h.title}</span><span style="opacity:0.7;">${h.date}</span>`;
                list.appendChild(li);
            });
        }
        window.clearHistory = () => { history = []; localStorage.removeItem('mimi_history'); updateHistoryUI(); };
        window.exportData = () => {
            const data = { history, disabledSongs, dailyCount, hapticsEnabled };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `mimi_backup.json`; document.body.appendChild(a); a.click(); a.remove();
        };
        window.importData = (input) => {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.history) { history = data.history; localStorage.setItem('mimi_history', JSON.stringify(history)); }
                    if(data.disabledSongs) { disabledSongs = data.disabledSongs; localStorage.setItem('mimi_disabled', JSON.stringify(disabledSongs)); }
                    if(data.dailyCount) { dailyCount = data.dailyCount; localStorage.setItem('mimi_daily_count', dailyCount); }
                    if(data.hapticsEnabled !== undefined) { hapticsEnabled = data.hapticsEnabled; localStorage.setItem('mimi_haptics', hapticsEnabled); }
                    alert("Done! Reloading..."); location.reload();
                } catch(err) { alert("Error"); }
            };
            reader.readAsText(file);
        };

        function applyTheme(theme) {
            const html = document.documentElement;
            const metaTheme = document.getElementById('metaThemeColor');
            if(theme === 'dark') {
                html.setAttribute('data-theme', 'dark');
                els.themeBtn.innerHTML = '<span class="material-icons-round">light_mode</span>';
                localStorage.setItem('theme', 'dark');
                metaTheme.setAttribute('content', '#0f172a');
            } else {
                html.removeAttribute('data-theme');
                els.themeBtn.innerHTML = '<span class="material-icons-round">dark_mode</span>';
                localStorage.setItem('theme', 'light');
                metaTheme.setAttribute('content', '#f5f7fa');
            }
        }
        els.themeBtn.addEventListener('click', () => applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

        function applyLang(lang) {
            currentLang = lang;
            localStorage.setItem('mimi_lang', lang);
            els.langLabel.innerText = lang.toUpperCase();
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(I18N[lang][key]) el.innerHTML = I18N[lang][key];
            });
            els.shareInput.placeholder = I18N[lang].placeholder;
            setMode(currentMode); // Update desc
        }
        els.langToggle.addEventListener('change', (e) => applyLang(e.target.checked ? 'en' : 'ja'));

        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        document.getElementById('settingsBtn').addEventListener('click', () => document.getElementById('settingsModal').classList.add('active'));
        document.getElementById('btnResetConfirm').addEventListener('click', () => {
            availableSongs = getActiveSongs();
            if(currentMode === 'daily') { dailyCount = 1; els.dailyInput.value = 1; localStorage.setItem('mimi_daily_count', 1); els.dailyBadge.innerText = `Day 1`; }
            document.getElementById('resetModal').classList.remove('active');
            confetti({ particleCount: 50, colors:['#74ebd5'] });
        });
        function renderStaticReel() {
            els.reel.innerHTML = '';
            if(allSongs.length === 0) return;
            allSongs.forEach(s => els.reel.appendChild(createItem(s.title)));
            allSongs.forEach(s => els.reel.appendChild(createItem(s.title))); 
            gsap.set(els.reel, { y: 105 }); 
        }
    </script>
</body>
</html>